<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Penjat</title>
    </head>

    <body>

        <button id="btIntroduirLletra">Introdueix una lletra</button>
        <button id="btAbandonar">Abandonar partida</button>

        <script>
            
            //deleteCookie("victories");
            //deleteCookie("derrotes");
            //deleteCookie("abandonaments");

            let finestra1, finestra2, finestra3;
            var llistaparaules, lletra, paraulaEnJoc, numParaules, numAleatori, srcImatge;
            var estatParaula = [];
            var numAbandonaments = 0;
            var paraulaIncognita = " ";
            var paraulaIncognitaFinal = " ";
            var numErrors = 0, pulsat = false, continua = true;

            document.getElementById("btAbandonar").addEventListener("click", abandonament);
            document.getElementById("btIntroduirLletra").addEventListener("click", introdueixLletra);

            iniciaPartida();
            
            function iniciaPartida(){ 
                var resposta = prompt("Entra una paraula o grup de paraules (separades per comes i sense espais):");
                //s'introdueixen més d'1 paraula
                if(resposta.includes(",")){
                    llistaparaules = resposta.trim().toLowerCase().split(",");
                    //console.log(llistaparaules);
                    //variable per saber el numero de paraules introduïdes
                    numParaules = llistaparaules.length;
                    //console.log(numParaules);
                    //num aleatori entre la posició 0 i el total de paraules (llistaparaules.length)
                    numAleatori = Math.floor(Math.random() * (numParaules - 0)) + 0;
                    //console.log(numAleatori);
                    //escollir aleatoriament una paraula per començar el joc
                    paraulaEnJoc = llistaparaules[numAleatori];
                    console.log(paraulaEnJoc);
                }
                //si no s'introdueix cap paraula, es juga una de les següents
                else if(resposta == ""){
                    llistaparaules = ["poma", "ulleres", "barcelona", "piscina", "neu"];
                    numParaules = llistaparaules.length;
                    numAleatori = Math.floor(Math.random() * (numParaules - 0)) + 0;
                    paraulaEnJoc = llistaparaules[numAleatori];
                    console.log(paraulaEnJoc);
                //si s'introdueix 1 paraula
                }
                
                else {
                    paraulaEnJoc = resposta.trim().toLowerCase();
                    console.log(paraulaEnJoc);
                }

                //obrim les tres finestres secundaries
                obrirFinestres();

                //reeiniciem els camps per si comença una nova patida
                estatParaula = [];
                paraulaIncognita = '';

                //omplim l'estat de la paraula amb espais incògnita
                for (var i=0; i < paraulaEnJoc.length; i++) {
                    estatParaula[i] = '_';
                }

                //preparem la paraula amb incognites que veura el usuari
                for (var i=0; i < estatParaula.length; i++) {
                    paraulaIncognita = paraulaIncognita + " " + estatParaula[i];
                }
                
                prepararParaulaIncognita();

                carregarEstadistiques();

            }

            function continuarPartida (){
                //tanquem les finestres amb la partida anterior per obrir les de la nova partida
                tancarFinestres();
                
                //tornem a obtenir una paraula random
                numParaules = llistaparaules.length;
                numAleatori = Math.floor(Math.random() * (numParaules - 0)) + 0;
                paraulaEnJoc = llistaparaules[numAleatori];
                console.log(paraulaEnJoc);

                //obrim les tres finestres secundaries
                obrirFinestres();

                //reeiniciem els camps per començar la nova patida
                estatParaula = [];
                paraulaIncognita = '';

                //omplim l'estat de la paraula amb espais incògnita
                for (var i=0; i < paraulaEnJoc.length; i++) {
                    estatParaula[i] = '_';
                }

                //preparem la paraula amb incognites que veura el usuari
                for (var i=0; i < estatParaula.length; i++) {
                    paraulaIncognita = paraulaIncognita + " " + estatParaula[i];
                }

                prepararParaulaIncognita();

                carregarEstadistiques();

            }

            function obrirFinestres(){
                finestra1 = window.open("finestra1.html", "finestra1", "top=300, left=400, width=300, height=200");
                finestra2 = window.open("finestra2.html", "finestra2", "top=600, left=400, width=300, height=200");
                finestra3 = window.open("finestra3.html", "finestra3", "top=450, left=1000, width=300, height=200");
            }

            function tancarFinestres(){
                finestra1.close();
                finestra2.close();
                finestra3.close();     
            }

            function abandonament (){
                
                //si la cookie no ha estat definida, la creem amb la valor 1
                if(getCookie('abandonaments') == 0){
                    document.cookie = "abandonaments=" + 1;
                //modifiquem el valor de la cookie
                }else {
                    numAbandonaments = parseInt(getCookie('abandonaments')) + 1 ;
                    document.cookie = "abandonaments=" +  numAbandonaments;
                } 

                //si volem abandonar i anteriorment hem introduit només una paraula, es dona l'opció de tornar a introduir-ne
                if (llistaparaules == undefined){
                        tancarFinestres();
                        setTimeout(iniciaPartida,5000);
                //si volem abandonar, però hi ha més paraules en joc continuem la partida.
                }else {
                    setTimeout(continuarPartida,5000);
                }  

            }

            //carreguem a les estadístiques a les cookies
            function carregarEstadistiques(){
                var cookieVictoria = getCookie("victories");
                var cookieDerrota = getCookie("derrotes");
                var cookieAbandonaments = getCookie("abandonaments");

                finestra3.window.onload = function() {
                    finestra3.window.document.getElementById("victories").innerText = "Victories: " + cookieVictoria;
                    finestra3.window.document.getElementById("derrotes").innerText = "Derrotes: " + cookieDerrota;
                    finestra3.window.document.getElementById("abandonaments").innerText = "Abandonaments: " + cookieAbandonaments;
                };      
            }

            //actualitzem les cookies
            function canviarEstadistiques(){
                var cookieVictoria = getCookie("victories");
                var cookieDerrota = getCookie("derrotes");
                var cookieAbandonaments = getCookie("abandonaments");

                finestra3.window.document.getElementById("victories").innerText = "Victories: " + cookieVictoria;
                finestra3.window.document.getElementById("derrotes").innerText = "Derrotes: " + cookieDerrota;
                finestra3.window.document.getElementById("abandonaments").innerText = "Abandonaments: " + cookieAbandonaments;   
            }


            //coloquem la paraula amb incognites a la finestra2 per començar el joc
            function prepararParaulaIncognita(){   
                finestra2.window.onload = function() {
                    finestra2.window.document.getElementById("paraulaincognita").innerText = paraulaIncognita;
                };
            }

            //modifiquem l'estat de la paraula incognita
            function canviarParaulaIncognita(){
                finestra2.window.document.getElementById("paraulaincognita").innerText = paraulaIncognita;
            }

            //modifiquem l'estat de les imatges
            function canviarImatgePenjat(numErrors){
                
                switch (numErrors){
                    case 1:
                        srcImatge = "img/1.jpg";
                    break;
                    case 2:
                        srcImatge = "img/2.jpg";
                    break;
                    case 3:
                        srcImatge = "img/3.jpg";
                    break;
                    case 4:
                        srcImatge = "img/4.jpg";
                    break;
                    case 5:
                        srcImatge = "img/5.jpg";
                       
                        alert("PENJAT !!");
                        //reiniciem la variable per les següents partides
                        var numDerrotes = 0; 

                        //si la cookie no ha estat definida, la creem amb la valor 1
                        if(getCookie('derrotes') == 0){
                                document.cookie = "derrotes=" + 1;
                        //modifiquem el valor de la cookie
                        }else {
                            numDerrotes = parseInt(getCookie('derrotes')) + 1 ;
                            document.cookie = "derrotes=" +  numDerrotes;
                        }

                        canviarEstadistiques();

                        //si volem abandonar i anteriorment hem introduit només una paraula, es dona l'opció de tornar a introduir-ne
                        if (llistaparaules == undefined){
                            tancarFinestres();
                            setTimeout(iniciaPartida,10000);
                        //si hi ha més paraules en joc continuem la partida.
                        }else {
                            setTimeout(continuarPartida,10000);
                        }

                    break;
                }
                
                finestra1.window.document.getElementById("imatgePenjat").src = srcImatge;

            }

            //introduïr i comprovar lletres
            function introdueixLletra(){

                lletra = prompt("Introdueixi la lletra desitjada: ");
                lletra = lletra.trim().toLowerCase();
                //comprovar si la lletra està o no a la paraula
                if(paraulaEnJoc.indexOf(lletra) != -1){

                    alert("La paraula en joc si conté la lletra " + lletra);
                    // comprovem si la paraula en joc conté la lletra i si és així ho canviem a estat paraula
                    for (var i=0; i < paraulaEnJoc.length; i++) {
                        if (paraulaEnJoc.charAt(i) == lletra){
                            estatParaula[i] = lletra;
                        }

                    }

                    paraulaIncognita = "";
                    
                    // canviem la paraula que mostrem a l'usuari amb el nou estat
                    for (var i=0; i < estatParaula.length; i++) {
                        paraulaIncognita = paraulaIncognita + " " + estatParaula[i];
                    }

                    canviarParaulaIncognita();

                    //com hem possat espais a la paraula incognita (per veure-la millor),
                    //els hem d'eliminar i comprovar si és igual que la paraula en joc
                    paraulaIncognitaFinal = "";

                    for (var i=0; i < estatParaula.length; i++) {
                        paraulaIncognitaFinal = paraulaIncognitaFinal + estatParaula[i];
                    }

                    console.log(paraulaIncognitaFinal);

                    if(paraulaEnJoc == paraulaIncognitaFinal){
                        alert('Victoria');
                        
                        var numVictories = 0;
                        
                        //si la cookie no ha estat definida, la creem amb la valor 1
                        if(getCookie('victories') == 0){
                            document.cookie = "victories=" + 1;
                        //modifiquem el seu valor
                        }else {
                            numVictories = parseInt(getCookie('victories')) + 1 ;
                            document.cookie = "victories=" +  numVictories;
                        }
                        
                        canviarEstadistiques();

                        //si volem abandonar i anteriorment hem introduit només una paraula, es dona l'opció de tornar a introduir-ne
                        if (llistaparaules == undefined){
                            tancarFinestres();
                            iniciaPartida();
                        //si hi ha més paraules en joc continuem la partida.
                        }else {
                            continuarPartida();
                        }
                        
                    }
                }
                
                else if (lletra == "") {
                    alert("Introdueixi una lletra si us plau...");
                } 
                
                else {
                    alert("La paraula en joc no conté la lletra " + lletra);
                    numErrors = numErrors + 1;
                    canviarImatgePenjat(numErrors);


                    if (numErrors == 5){
                    //reiniciem la variable per les següents partides
                    numErrors = 0;

                    }

                    
                }
            }

            //creació de cookies
            function setCookie(name, value, days) {
                var d = new Date;
                d.setTime(d.getTime() + 24*60*60*1000*days);
                document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
            }
            
            //obtenir cookie
            function getCookie(name) {
                var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
                return v ? v[2] : 0;
            }
            
            //esborrar una cookie
            function deleteCookie(name) { 
                setCookie(name, '', -1); 
            }
            
        </script>
    </body>

</html>