<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Finestra Principal</title>
    </head>

    <body>

        <button id="btIntroduirLletra">Introdueix una lletra</button>
        <button id="btAbandonar">Abandonar partida</button>

        <script>
            
            let finestra1, finestra2, finestra3;
            var llistaparaules, lletra, paraulaEnJoc, numParaules, numAleatori, srcImatge;
            var estatParaula = [];
            var paraulaIncognita = "";
            var numErrors = 0, pulsat = false, continua = true;

            document.getElementById("btAbandonar").addEventListener("click", tancarFinestres);
            document.getElementById("btIntroduirLletra").addEventListener("click", introdueixLletra);

            iniciaPartida();
            
            function iniciaPartida(){ 
                var resposta = prompt("Entra una paraula o grup de paraules (separades per comes i sense espais):");
                //s'introdueixen més d'1 paraula
                if(resposta.includes(",")){
                    llistaparaules = resposta.trim().toLowerCase().split(",");
                    //console.log(llistaparaules);
                    //variable per saber el numero de paraules introduïdes
                    numParaules = llistaparaules.length;
                    //console.log(numParaules);
                    //num aleatori entre la posició 0 i el total de paraules (llistaparaules.length)
                    numAleatori = Math.floor(Math.random() * (numParaules - 0)) + 0;
                    //console.log(numAleatori);
                    //escollir aleatoriament una paraula per començar el joc
                    paraulaEnJoc = llistaparaules[numAleatori];
                    console.log(paraulaEnJoc);
                }
                //si no s'introdueix cap paraula, es juga una de les següents
                else if(resposta == ""){
                    llistaparaules = ["poma", "ulleres", "barcelona", "piscina", "neu"];
                    numParaules = llistaparaules.length;
                    numAleatori = Math.floor(Math.random() * (numParaules - 0)) + 0;
                    paraulaEnJoc = llistaparaules[numAleatori];
                    console.log(paraulaEnJoc);
                //si s'introdueix 1 paraula
                }else {
                    paraulaEnJoc = resposta.trim().toLowerCase();
                    console.log(paraulaEnJoc);
                }

                //obrim les tres finestres secundaries
                obrirFinestres();

                

                //omplim l'estat de la paraula amb espais incògnita
                for (var i=0; i < paraulaEnJoc.length; i++) {
                    estatParaula[i] = '_';
                }

                //preparem la paraula amb incognites
                for (var i=0; i < estatParaula.length; i++) {
                    paraulaIncognita = paraulaIncognita + " " + estatParaula[i];
                }

                prepararParaulaIncognita();
                estadistiques();

            }

            function obrirFinestres(){
                finestra1 = window.open("finestra1.html", "finestra1", "top=300, left=400, width=300, height=200");
                finestra2 = window.open("finestra2.html", "finestra2", "top=600, left=400, width=300, height=200");
                finestra3 = window.open("finestra3.html", "finestra3", "top=450, left=1000, width=300, height=200");
            }

            function tancarFinestres(opcio){
                finestra1.close();
                finestra2.close();
                finestra3.close();

                if(opcio == "Penjat"){
                    setTimeout(iniciaPartida,10000);
                }else{
                    var numAbandonaments = 0; 
                    document.cookie = "abandonaments=" + numAbandonaments + 1;
                    setTimeout(iniciaPartida,5000);
                }
            }

            function estadistiques(){
                var cookieVictoria = getCookie("victories");
                var cookieDerrota = getCookie("derrotes");
                var cookieAbandonaments = getCookie("abandonaments");

                finestra3.window.onload = function() {
                    finestra3.window.document.getElementById("victories").innerText = "Victories: " + cookieVictoria;
                    finestra3.window.document.getElementById("derrotes").innerText = "Derrotes: " + cookieDerrota;
                    finestra3.window.document.getElementById("abandonaments").innerText = "Abandonaments: " + cookieAbandonaments;
                };        

            }

            //coloquem la paraula amb incognites a la finestra2 per començar el joc
            function prepararParaulaIncognita(){                
                finestra2.window.onload = function() {
                    finestra2.window.document.getElementById("paraulaincognita").innerText = paraulaIncognita;
                };
            }

            function canviarParaulaIncognita(){
                finestra2.window.document.getElementById("paraulaincognita").innerText = paraulaIncognita;
            }

            function canviarImatgePenjat(numErrors){
                
                switch (numErrors){
                    case 1:
                        srcImatge = "img/1.jpg";
                    break;
                    case 2:
                        srcImatge = "img/2.jpg";
                    break;
                    case 3:
                        srcImatge = "img/3.jpg";
                    break;
                    case 4:
                        srcImatge = "img/4.jpg";
                    break;
                    case 5:
                        srcImatge = "img/5.jpg";
                    break;
                }
                
                finestra1.window.document.getElementById("imatgePenjat").src = srcImatge;

            }

            

            //introduïr i comprovar lletres
            function introdueixLletra(){
                
                lletra = prompt("Introdueixi la lletra desitjada: ");
                lletra = lletra.trim().toLowerCase();
                //comprovar si la lletra està o no a la paraula
                if(paraulaEnJoc.indexOf(lletra) != -1){

                    alert("La paraula en joc si conté la lletra " + lletra);
                    // comprovem si la paraula en joc conté la lletra i si és així ho canviem a estat paraula
                    for (var i=0; i < paraulaEnJoc.length; i++) {
                        if (paraulaEnJoc.charAt(i) == lletra){
                            estatParaula[i] = lletra;
                        }

                    }

                    paraulaIncognita = "";
                    
                    // canviem la paraula que mostrem a l'usuari amb el nou estat
                    for (var i=0; i < estatParaula.length; i++) {
                        paraulaIncognita = paraulaIncognita + " " + estatParaula[i];
                    }

                    canviarParaulaIncognita();

                    //com hem possat espais a la paraula incognita (per veure-la millor),
                    //els hem d'eliminar i comprovar si és igual que la paraula en joc
                    // /_/g --> expressió regular que busca espais, la g és de(global)
                    if(paraulaIncognita.replace(/ /g, "")==paraulaEnJoc){
                        alert('Victoria');
                        var numVictories = 0; 
                        document.cookie = "victories=" + numVictories + 1;
                    }

                }
                
                else if (lletra == "") {
                    alert("Introdueixi una lletra si us plau...");
                } 
                
                else {
                    if(numErrors == 5){
                        alert("PENJAT !!");
                        var numDerrotes = 0; 
                        document.cookie = "derrotes=" + numDerrotes + 1;
                        tancarFinestres("Penjat");
                        
                    }else {
                        alert("La paraula en joc no conté la lletra " + lletra);
                        numErrors = numErrors + 1;
                        canviarImatgePenjat(numErrors);

                    }
                }
            }

            function setCookie(name, value, days) {
                var d = new Date;
                d.setTime(d.getTime() + 24*60*60*1000*days);
                document.cookie = name + "=" + value + ";path=/;expires=" + d.toGMTString();
            }

            function getCookie(name) {
            var v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
            }

            function deleteCookie(name) { 
                setCookie(name, '', -1); 
            }
            
        </script>
    </body>

</html>